# ═══════════════════════════════════════════════════════════════
#  Project LABYRINTH — Docker Compose (Test Mode)
#  Authors: Stephen Stewart & Claude (Anthropic)
# ═══════════════════════════════════════════════════════════════

services:

  # ── Layer 1: SSH Portal Trap ────────────────────────────────
  honeypot-ssh:
    build:
      context: .
      dockerfile: docker/honeypot-ssh.Dockerfile
    container_name: labyrinth-ssh
    labels:
      project: labyrinth
      layer: "1"
    ports:
      - "2222:22"
    networks:
      - labyrinth-net
    volumes:
      - forensic-data:/var/labyrinth/forensics
    restart: unless-stopped

  # ── Layer 1: HTTP Portal Trap ───────────────────────────────
  honeypot-http:
    build:
      context: .
      dockerfile: docker/honeypot-http.Dockerfile
    container_name: labyrinth-http
    labels:
      project: labyrinth
      layer: "1"
    ports:
      - "8080:80"
    networks:
      - labyrinth-net
    volumes:
      - forensic-data:/var/labyrinth/forensics
    restart: unless-stopped

  # ── Orchestrator ──────────────────────────────────────────
  orchestrator:
    build:
      context: .
      dockerfile: docker/orchestrator.Dockerfile
    container_name: labyrinth-orchestrator
    labels:
      project: labyrinth
      layer: orchestrator
    networks:
      - labyrinth-net
    volumes:
      - forensic-data:/var/labyrinth/forensics
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      - LABYRINTH_MODE=test
      - LABYRINTH_LOG_LEVEL=DEBUG
    depends_on:
      - honeypot-ssh
      - honeypot-http
    restart: unless-stopped

  # ── Layer 4: MITM Proxy ──────────────────────────────────
  proxy:
    build:
      context: .
      dockerfile: docker/proxy.Dockerfile
    container_name: labyrinth-proxy
    labels:
      project: labyrinth
      layer: "4"
    networks:
      labyrinth-net:
        ipv4_address: 172.30.0.50
    volumes:
      - forensic-data:/var/labyrinth/forensics
    environment:
      - PROXY_MODE=passive
      - LABYRINTH_L4_MODE=passive
    restart: unless-stopped

  # ── Session Template (build only, not a running service) ──
  session-template:
    build:
      context: .
      dockerfile: docker/session-template.Dockerfile
    image: labyrinth-session-template
    container_name: labyrinth-session-template-build
    labels:
      project: labyrinth
      layer: session
    entrypoint: ["echo", "Template image built successfully"]

  # ── Dashboard ─────────────────────────────────────────────
  dashboard:
    build:
      context: .
      dockerfile: docker/dashboard.Dockerfile
    container_name: labyrinth-dashboard
    labels:
      project: labyrinth
      layer: dashboard
    ports:
      - "9000:9000"
    networks:
      - labyrinth-net
    volumes:
      - forensic-data:/var/labyrinth/forensics:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
    environment:
      - DASHBOARD_PORT=9000
    depends_on:
      - orchestrator
    restart: unless-stopped

networks:
  labyrinth-net:
    driver: bridge
    labels:
      project: labyrinth
    ipam:
      config:
        - subnet: 172.30.0.0/24

volumes:
  forensic-data:
    labels:
      project: labyrinth
